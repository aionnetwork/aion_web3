<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: lib/solidity/coder.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: lib/solidity/coder.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/*
    This file is part of web3.js.

    web3.js is free software: you can redistribute it and/or modify
    it under the terms of the GNU Lesser General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    web3.js is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Lesser General Public License for more details.

    You should have received a copy of the GNU Lesser General Public License
    along with web3.js.  If not, see &lt;http://www.gnu.org/licenses/>.
*/
/**
 * @file coder.js
 * @author Marek Kotewicz &lt;marek@ethdev.com>
 * @date 2015
 */

var f = require('./formatters');

var SolidityTypeAddress = require('./address');
var SolidityTypeBool = require('./bool');
var SolidityTypeInt = require('./int');
var SolidityTypeUInt = require('./uint');
var SolidityTypeDynamicBytes = require('./dynamicbytes');
var SolidityTypeString = require('./string');
var SolidityTypeReal = require('./real');
var SolidityTypeUReal = require('./ureal');
var SolidityTypeBytes = require('./bytes');

var isDynamic = function (solidityType, type) {
   return solidityType.isDynamicType(type) ||
          solidityType.isDynamicArray(type);
};

/**
 * SolidityCoder prototype should be used to encode/decode solidity params of any type
 */
var SolidityCoder = function (types) {
    this._types = types;
};

/**
 * This method should be used to transform type to SolidityType
 *
 * @method _requireType
 * @param {String} type
 * @returns {SolidityType}
 * @throws {Error} throws if no matching type is found
 */
SolidityCoder.prototype._requireType = function (type) {
    var solidityType = this._types.filter(function (t) {
        return t.isType(type);
    })[0];

    if (!solidityType) {
        throw Error('invalid solidity type!: ' + type);
    }

    return solidityType;
};

/**
 * Should be used to encode plain param
 *
 * @method encodeParam
 * @param {String} type
 * @param {Object} plain param
 * @return {String} encoded plain param
 */
SolidityCoder.prototype.encodeParam = function (type, param) {
    if(process.env.debug) console.log('[SolidityCoder.encodeParam]')

    return this.encodeParams([type], [param]);
};

/**
 * Should be used to encode list of params
 *
 * @method encodeParams
 * @param {Array} types
 * @param {Array} params
 * @return {String} encoded list of params
 */
SolidityCoder.prototype.encodeParams = function (types, params) {
    if(process.env.debug) console.log('[SolidityCoder.encodeParams]')

    var solidityTypes = this.getSolidityTypes(types);

    var encodeds = solidityTypes.map(function (solidityType, index) {
        if(process.env.debug) console.log('[SolidityCoder.encodeParamsType] ' + types[index])
        return solidityType.encode(params[index], types[index]);
    });

    var dynamicOffset = solidityTypes.reduce(function (acc, solidityType, index) {
        var staticPartLength = solidityType.staticPartLength(types[index]);
        var roundedStaticPartLength = Math.floor((staticPartLength + 15) / 16) * 16;

        // console.log('-------------------------------------')
        // console.log(types[index])
        // console.log(isDynamic(solidityTypes[index], types[index]))
        // console.log(roundedStaticPartLength)
        // console.log(acc + (isDynamic(solidityTypes[index], types[index]) ?
        //     16 :
        //     roundedStaticPartLength))
        // console.log('------------------------------------')
        
        return acc + (isDynamic(solidityTypes[index], types[index]) ?
            16 :
            roundedStaticPartLength);
    }, 0);

    // console.log('---------------------------------------------------')
    // console.log(encodeds)
    // console.log(dynamicOffset + ' ' + typeof(dynamicOffset))
    // console.log('---------------------------------------------------')
    var result = this.encodeMultiWithOffset(types, solidityTypes, encodeds, dynamicOffset);

    return result;
};

SolidityCoder.prototype.encodeMultiWithOffset = function (types, solidityTypes, encodeds, dynamicOffset) {
    var result = "";
    var self = this;

    types.forEach(function (type, i) {
        if (isDynamic(solidityTypes[i], types[i])) {
            result += f.formatInputInt(dynamicOffset).encode();
            var e = self.encodeWithOffset(types[i], solidityTypes[i], encodeds[i], dynamicOffset);
            dynamicOffset += e.length / 2;
        } else {
            // don't add length to dynamicOffset. it's already counted
            result += self.encodeWithOffset(types[i], solidityTypes[i], encodeds[i], dynamicOffset);
        }

        // TODO: figure out nested arrays
    });

    types.forEach(function (type, i) {
        if (isDynamic(solidityTypes[i], types[i])) {
            var e = self.encodeWithOffset(types[i], solidityTypes[i], encodeds[i], dynamicOffset);
            dynamicOffset += e.length / 2;
            result += e;
        }
    });
    return result;
};

// TODO: refactor whole encoding!
SolidityCoder.prototype.encodeWithOffset = function (type, solidityType, encoded, offset) {

    var self = this;
    if (solidityType.isDynamicArray(type)) {
        return (function () {
            // offset was already set
            var nestedName = solidityType.nestedName(type);
            var nestedStaticPartLength = solidityType.staticPartLength(nestedName);
            var result = encoded[0];

            (function () {
                var previousLength = 2; // in int
                if (solidityType.isDynamicArray(nestedName)) {
                    for (var i = 1; i &lt; encoded.length; i++) {
                        previousLength += +(encoded[i - 1])[0] || 0;
                        result += f.formatInputInt(offset + i * nestedStaticPartLength + previousLength * 32).encode();
                    }
                }
            })();

            // first element is length, skip it
            (function () {
                for (var i = 0; i &lt; encoded.length - 1; i++) {
                    var additionalOffset = result / 2;
                    result += self.encodeWithOffset(nestedName, solidityType, encoded[i + 1], offset +  additionalOffset);
                }
            })();

            return result;
        })();

    } else if (solidityType.isStaticArray(type)) {
        return (function () {
            var nestedName = solidityType.nestedName(type);
            var nestedStaticPartLength = solidityType.staticPartLength(nestedName);
            var result = "";


            if (solidityType.isDynamicArray(nestedName)) {
                (function () {
                    var previousLength = 0; // in int
                    for (var i = 0; i &lt; encoded.length; i++) {
                        // calculate length of previous item
                        previousLength += +(encoded[i - 1] || [])[0] || 0;
                        result += f.formatInputInt(offset + i * nestedStaticPartLength + previousLength * 32).encode();
                    }
                })();
            }

            (function () {
                for (var i = 0; i &lt; encoded.length; i++) {
                    var additionalOffset = result / 2;
                    result += self.encodeWithOffset(nestedName, solidityType, encoded[i], offset + additionalOffset);
                }
            })();

            return result;
        })();
    }

    return encoded;
};

/**
 * Should be used to decode bytes to plain param
 *
 * @method decodeParam
 * @param {String} type
 * @param {String} bytes
 * @return {Object} plain param
 */
SolidityCoder.prototype.decodeParam = function (type, bytes) {
    if(process.env.debug) console.log('[SolidityCoder.decodeParam]')
    return this.decodeParams([type], bytes)[0];
};

/**
 * Should be used to decode list of params
 *
 * @method decodeParam
 * @param {Array} types
 * @param {String} bytes
 * @return {Array} array of plain params
 */
SolidityCoder.prototype.decodeParams = function (types, bytes) {
    if(process.env.debug) console.log('[SolidityCoder.decodeParams]')
    var solidityTypes = this.getSolidityTypes(types);
    var offsets = this.getOffsets(types, solidityTypes);
    return solidityTypes.map(function (solidityType, index) {
        if(process.env.debug) console.log('[SolidityCoder.decodeParamsType] ' + types[index])
        return solidityType.decode(bytes, offsets[index],  types[index], index);
    });
};

SolidityCoder.prototype.getOffsets = function (types, solidityTypes) {
    var lengths =  solidityTypes.map(function (solidityType, index) {
        return solidityType.staticPartLength(types[index]);
    });

    for (var i = 1; i &lt; lengths.length; i++) {
         // sum with length of previous element
        lengths[i] += lengths[i - 1];
    }

    return lengths.map(function (length, index) {
        // remove the current length, so the length is sum of previous elements
        var staticPartLength = solidityTypes[index].staticPartLength(types[index]);
        return length - staticPartLength;
    });
};

SolidityCoder.prototype.getSolidityTypes = function (types) {
    var self = this;
    return types.map(function (type) {
        return self._requireType(type);
    });
};

var coder = new SolidityCoder([
    new SolidityTypeAddress(),
    new SolidityTypeBool(),
    new SolidityTypeInt(),
    new SolidityTypeUInt(),
    new SolidityTypeDynamicBytes(),
    new SolidityTypeBytes(),
    new SolidityTypeString(),
    new SolidityTypeReal(),
    new SolidityTypeUReal()
]);

module.exports = coder;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-abi.html">abi</a></li><li><a href="module-Avm.html">Avm</a></li><li><a href="module-Avm-abi.html">Avm-abi</a></li><li><a href="module-Avm-contract.html">Avm-contract</a></li><li><a href="module-utils.html">utils</a></li></ul><h3>Classes</h3><ul><li><a href="bloom.html">bloom</a></li><li><a href="global.html#Contract">Contract</a></li><li><a href="module-Avm-Avm.html">Avm</a></li><li><a href="module-utils-BigNumber.html">BigNumber</a></li></ul><h3>Global</h3><ul><li><a href="global.html#$u">$u</a></li><li><a href="global.html#_addResponseCallback">_addResponseCallback</a></li><li><a href="global.html#_checkListener">_checkListener</a></li><li><a href="global.html#_createTxObject">_createTxObject</a></li><li><a href="global.html#_decodeEventABI">_decodeEventABI</a></li><li><a href="global.html#_decodeMethodReturn">_decodeMethodReturn</a></li><li><a href="global.html#_encodeEventABI">_encodeEventABI</a></li><li><a href="global.html#_encodeMethodABI">_encodeMethodABI</a></li><li><a href="global.html#_executeMethod">_executeMethod</a></li><li><a href="global.html#_fireError">_fireError</a></li><li><a href="global.html#_flattenTypes">_flattenTypes</a></li><li><a href="global.html#_generateEventOptions">_generateEventOptions</a></li><li><a href="global.html#_getCallback">_getCallback</a></li><li><a href="global.html#_getOrSetDefaultOptions">_getOrSetDefaultOptions</a></li><li><a href="global.html#_jsonInterfaceMethodToString">_jsonInterfaceMethodToString</a></li><li><a href="global.html#_on">_on</a></li><li><a href="global.html#_parseResponse">_parseResponse</a></li><li><a href="global.html#_processExecuteArguments">_processExecuteArguments</a></li><li><a href="global.html#_requireType">_requireType</a></li><li><a href="global.html#_timeout">_timeout</a></li><li><a href="global.html#_txInputFormatter">_txInputFormatter</a></li><li><a href="global.html#ABICoder">ABICoder</a></li><li><a href="global.html#add">add</a></li><li><a href="global.html#addDefaultEvents">addDefaultEvents</a></li><li><a href="global.html#addEventsToContract">addEventsToContract</a></li><li><a href="global.html#addFunctionsToContract">addFunctionsToContract</a></li><li><a href="global.html#addSubscription">addSubscription</a></li><li><a href="global.html#asciiToHex">asciiToHex</a></li><li><a href="global.html#at">at</a></li><li><a href="global.html#attachToContract">attachToContract</a></li><li><a href="global.html#attachToObject">attachToObject</a></li><li><a href="global.html#blake2b256">blake2b256</a></li><li><a href="global.html#bytesToHex">bytesToHex</a></li><li><a href="global.html#call">call</a></li><li><a href="global.html#chai">chai</a></li><li><a href="global.html#checkAddressChecksum">checkAddressChecksum</a></li><li><a href="global.html#checkForContractAddress">checkForContractAddress</a></li><li><a href="global.html#clone">clone</a></li><li><a href="global.html#combine">combine</a></li><li><a href="global.html#contract">contract</a></li><li><a href="global.html#ContractFactory">ContractFactory</a></li><li><a href="global.html#decode">decode</a></li><li><a href="global.html#decodeLog">decodeLog</a></li><li><a href="global.html#decodeParam">decodeParam</a></li><li><a href="global.html#decodeParameter">decodeParameter</a></li><li><a href="global.html#deploy">deploy</a></li><li><a href="global.html#displayName">displayName</a></li><li><a href="global.html#Documentation">Documentation</a></li><li><a href="global.html#dynamicPart">dynamicPart</a></li><li><a href="global.html#dynamicPartLength">dynamicPartLength</a></li><li><a href="global.html#encode">encode</a></li><li><a href="global.html#encodeConstructorParams">encodeConstructorParams</a></li><li><a href="global.html#encodeEventSignature">encodeEventSignature</a></li><li><a href="global.html#encodeFunctionCall">encodeFunctionCall</a></li><li><a href="global.html#encodeFunctionSignature">encodeFunctionSignature</a></li><li><a href="global.html#encodeList">encodeList</a></li><li><a href="global.html#encodeParam">encodeParam</a></li><li><a href="global.html#encodeParameter">encodeParameter</a></li><li><a href="global.html#encodeParameters">encodeParameters</a></li><li><a href="global.html#encodeParams">encodeParams</a></li><li><a href="global.html#equalBuffers">equalBuffers</a></li><li><a href="global.html#estimateGas">estimateGas</a></li><li><a href="global.html#eventifiedPromise">eventifiedPromise</a></li><li><a href="global.html#execute">execute</a></li><li><a href="global.html#extractCallback">extractCallback</a></li><li><a href="global.html#formatDynamicInputBytes">formatDynamicInputBytes</a></li><li><a href="global.html#formatInput">formatInput</a></li><li><a href="global.html#formatInputBool">formatInputBool</a></li><li><a href="global.html#formatInputBytes">formatInputBytes</a></li><li><a href="global.html#formatInputInt">formatInputInt</a></li><li><a href="global.html#formatInputReal">formatInputReal</a></li><li><a href="global.html#formatInputString">formatInputString</a></li><li><a href="global.html#formatOutput">formatOutput</a></li><li><a href="global.html#formatOutputAddress">formatOutputAddress</a></li><li><a href="global.html#formatOutputBool">formatOutputBool</a></li><li><a href="global.html#formatOutputBytes">formatOutputBytes</a></li><li><a href="global.html#formatOutputDynamicBytes">formatOutputDynamicBytes</a></li><li><a href="global.html#formatOutputInt">formatOutputInt</a></li><li><a href="global.html#formatOutputReal">formatOutputReal</a></li><li><a href="global.html#formatOutputString">formatOutputString</a></li><li><a href="global.html#formatOutputUInt">formatOutputUInt</a></li><li><a href="global.html#formatOutputUReal">formatOutputUReal</a></li><li><a href="global.html#fromNAmp">fromNAmp</a></li><li><a href="global.html#getCall">getCall</a></li><li><a href="global.html#getData">getData</a></li><li><a href="global.html#getLogsAtStart">getLogsAtStart</a></li><li><a href="global.html#getPastEvents">getPastEvents</a></li><li><a href="global.html#getUnitValue">getUnitValue</a></li><li><a href="global.html#getValueOfUnit">getValueOfUnit</a></li><li><a href="global.html#hasTopic">hasTopic</a></li><li><a href="global.html#hexToAscii">hexToAscii</a></li><li><a href="global.html#hexToBuffer">hexToBuffer</a></li><li><a href="global.html#hexToBytes">hexToBytes</a></li><li><a href="global.html#hexToNumber">hexToNumber</a></li><li><a href="global.html#hexToNumberString">hexToNumberString</a></li><li><a href="global.html#hexToUtf8">hexToUtf8</a></li><li><a href="global.html#HttpProvider">HttpProvider</a></li><li><a href="global.html#inputCallFormatter">inputCallFormatter</a></li><li><a href="global.html#inputLogFormatter">inputLogFormatter</a></li><li><a href="global.html#inputPostFormatter">inputPostFormatter</a></li><li><a href="global.html#inputSignFormatter">inputSignFormatter</a></li><li><a href="global.html#inputTransactionFormatter">inputTransactionFormatter</a></li><li><a href="global.html#inputZipfileBase64EncodingFormatter">inputZipfileBase64EncodingFormatter</a></li><li><a href="global.html#isAddress">isAddress</a></li><li><a href="global.html#isBigNumber">isBigNumber</a></li><li><a href="global.html#isBloom">isBloom</a></li><li><a href="global.html#isBN">isBN</a></li><li><a href="global.html#isConnected">isConnected</a></li><li><a href="global.html#isDynamic">isDynamic</a></li><li><a href="global.html#isDynamicArray">isDynamicArray</a></li><li><a href="global.html#isDynamicType">isDynamicType</a></li><li><a href="global.html#isHex">isHex</a></li><li><a href="global.html#isHexStrict">isHexStrict</a></li><li><a href="global.html#isSimplifiedStructFormat">isSimplifiedStructFormat</a></li><li><a href="global.html#isStaticArray">isStaticArray</a></li><li><a href="global.html#isTopic">isTopic</a></li><li><a href="global.html#isType">isType</a></li><li><a href="global.html#isValidResponse">isValidResponse</a></li><li><a href="global.html#leftPad">leftPad</a></li><li><a href="global.html#mapStructNameAndType">mapStructNameAndType</a></li><li><a href="global.html#mapStructToCoderFormat">mapStructToCoderFormat</a></li><li><a href="global.html#mapTypes">mapTypes</a></li><li><a href="global.html#nestedName">nestedName</a></li><li><a href="global.html#nestedTypes">nestedTypes</a></li><li><a href="global.html#new">new</a></li><li><a href="global.html#numberToHex">numberToHex</a></li><li><a href="global.html#offsetAsBytes">offsetAsBytes</a></li><li><a href="global.html#on">on</a></li><li><a href="global.html#once">once</a></li><li><a href="global.html#outputBigNumberFormatter">outputBigNumberFormatter</a></li><li><a href="global.html#outputBlockFormatter">outputBlockFormatter</a></li><li><a href="global.html#outputLogFormatter">outputLogFormatter</a></li><li><a href="global.html#outputPostFormatter">outputPostFormatter</a></li><li><a href="global.html#outputTransactionFormatter">outputTransactionFormatter</a></li><li><a href="global.html#outputTransactionReceiptFormatter">outputTransactionReceiptFormatter</a></li><li><a href="global.html#parseType">parseType</a></li><li><a href="global.html#poll">poll</a></li><li><a href="global.html#pollFilter">pollFilter</a></li><li><a href="global.html#pollSyncing">pollSyncing</a></li><li><a href="global.html#prepareRequest">prepareRequest</a></li><li><a href="global.html#prependZeroX">prependZeroX</a></li><li><a href="global.html#randomHexBuffer">randomHexBuffer</a></li><li><a href="global.html#reconnect">reconnect</a></li><li><a href="global.html#removeAllListeners">removeAllListeners</a></li><li><a href="global.html#removeLeadingZeroX">removeLeadingZeroX</a></li><li><a href="global.html#removeListener">removeListener</a></li><li><a href="global.html#removeSubscription">removeSubscription</a></li><li><a href="global.html#request">request</a></li><li><a href="global.html#RequestManager">RequestManager</a></li><li><a href="global.html#reset">reset</a></li><li><a href="global.html#rightPad">rightPad</a></li><li><a href="global.html#Scorer">Scorer</a></li><li><a href="global.html#Search">Search</a></li><li><a href="global.html#send">send</a></li><li><a href="global.html#sendAsync">sendAsync</a></li><li><a href="global.html#sendBatch">sendBatch</a></li><li><a href="global.html#sendTransaction">sendTransaction</a></li><li><a href="global.html#setProvider">setProvider</a></li><li><a href="global.html#sha3">sha3</a></li><li><a href="global.html#signature">signature</a></li><li><a href="global.html#signedIsNegative">signedIsNegative</a></li><li><a href="global.html#solidityBlake2b256">solidityBlake2b256</a></li><li><a href="global.html#SolidityCoder">SolidityCoder</a></li><li><a href="global.html#SolidityEvent">SolidityEvent</a></li><li><a href="global.html#SolidityFunction">SolidityFunction</a></li><li><a href="global.html#SolidityParam">SolidityParam</a></li><li><a href="global.html#SolidityType">SolidityType</a></li><li><a href="global.html#SolidityTypeAddress">SolidityTypeAddress</a></li><li><a href="global.html#SolidityTypeBool">SolidityTypeBool</a></li><li><a href="global.html#SolidityTypeBytes">SolidityTypeBytes</a></li><li><a href="global.html#SolidityTypeInt">SolidityTypeInt</a></li><li><a href="global.html#SolidityTypeReal">SolidityTypeReal</a></li><li><a href="global.html#SolidityTypeUInt">SolidityTypeUInt</a></li><li><a href="global.html#SolidityTypeUReal">SolidityTypeUReal</a></li><li><a href="global.html#startPolling">startPolling</a></li><li><a href="global.html#startsWithZeroX">startsWithZeroX</a></li><li><a href="global.html#staticArrayLength">staticArrayLength</a></li><li><a href="global.html#staticPart">staticPart</a></li><li><a href="global.html#staticPartLength">staticPartLength</a></li><li><a href="global.html#Stemmer">Stemmer</a></li><li><a href="global.html#stopPolling">stopPolling</a></li><li><a href="global.html#subscribe">subscribe</a></li><li><a href="global.html#testAddress">testAddress</a></li><li><a href="global.html#toBatchPayload">toBatchPayload</a></li><li><a href="global.html#toBN">toBN</a></li><li><a href="global.html#toBuffer">toBuffer</a></li><li><a href="global.html#toChecksumAddress">toChecksumAddress</a></li><li><a href="global.html#toHex">toHex</a></li><li><a href="global.html#toNAmp">toNAmp</a></li><li><a href="global.html#toPayload">toPayload</a></li><li><a href="global.html#toTopic">toTopic</a></li><li><a href="global.html#toTwosComplement">toTwosComplement</a></li><li><a href="global.html#typeName">typeName</a></li><li><a href="global.html#types">types</a></li><li><a href="global.html#unsubscribe">unsubscribe</a></li><li><a href="global.html#utf8ToHex">utf8ToHex</a></li><li><a href="global.html#validateArgs">validateArgs</a></li><li><a href="global.html#withOffset">withOffset</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.3</a> on Sun Aug 25 2019 13:12:30 GMT-0400 (Atlantic Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
